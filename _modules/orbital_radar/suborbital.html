<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>orbital_radar.suborbital &mdash; orbital-radar 0.0.2 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            orbital-radar
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting Started with Orbital-Radar</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api-reference.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../output_description.html">Variable List - Output file</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../acknowledgments.html">Acknowledgments</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">orbital-radar</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">orbital_radar.suborbital</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for orbital_radar.suborbital</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module contains the OrbitalRadar class that runs the simulator for</span>
<span class="sd">suborbital radar data. It is a subclass of the Simulator class.</span>

<span class="sd">Difference between ground-based and airborne radar geometry:</span>
<span class="sd">- along-track coordinate from mean wind for ground based and mean flight vel.</span>
<span class="sd">from airborne radar</span>
<span class="sd">- no ground echo added to airborne radar</span>
<span class="sd">- range grid of airborne radar assumed to be height above mean sea level and</span>
<span class="sd">height above ground for groundbased</span>
<span class="sd">- no attenuation correction for airborne radar</span>
<span class="sd">- lat/lon coordinates included as input to airborne radar</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>

<span class="kn">from</span> <span class="nn">orbital_radar.helpers</span> <span class="kn">import</span> <span class="n">db2li</span><span class="p">,</span> <span class="n">li2db</span>
<span class="kn">from</span> <span class="nn">orbital_radar.radarspec</span> <span class="kn">import</span> <span class="n">RadarBeam</span>
<span class="kn">from</span> <span class="nn">orbital_radar.readers.cloudnet</span> <span class="kn">import</span> <span class="n">read_cloudnet</span>
<span class="kn">from</span> <span class="nn">orbital_radar.readers.config</span> <span class="kn">import</span> <span class="n">read_config</span>
<span class="kn">from</span> <span class="nn">orbital_radar.readers.radar</span> <span class="kn">import</span> <span class="n">Radar</span>
<span class="kn">from</span> <span class="nn">orbital_radar.simulator</span> <span class="kn">import</span> <span class="n">Simulator</span>
<span class="kn">from</span> <span class="nn">orbital_radar.version</span> <span class="kn">import</span> <span class="n">__version__</span>
<span class="kn">from</span> <span class="nn">orbital_radar.writers.spaceview</span> <span class="kn">import</span> <span class="n">write_spaceview</span>


<div class="viewcode-block" id="Suborbital"><a class="viewcode-back" href="../../api/suborbital.html#orbital_radar.suborbital.Suborbital">[docs]</a><span class="k">class</span> <span class="nc">Suborbital</span><span class="p">(</span><span class="n">Simulator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run the simulator for suborbital radar data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># list of all suborbital radar locations</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;groundbased&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;bco&quot;</span><span class="p">,</span>
            <span class="s2">&quot;jue&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nor&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mag&quot;</span><span class="p">,</span>
            <span class="s2">&quot;min&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nya&quot;</span><span class="p">,</span>
            <span class="s2">&quot;arm&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pamtra&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s2">&quot;airborne&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;mp5&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rasta&quot;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">geometry</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">config_file</span><span class="p">,</span> <span class="n">suborbital_radar</span><span class="p">,</span> <span class="n">input_radar_format</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the simulator for suborbital radar data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        geometry : str</span>
<span class="sd">            Observation geometry of radar (groundbased or airborne).</span>
<span class="sd">        name : str</span>
<span class="sd">            Name of the suborbital radar (abbreviated).</span>
<span class="sd">        config_file : str</span>
<span class="sd">            Path to the configuration file that contains the site-dependent</span>
<span class="sd">            parameters and directory paths.</span>
<span class="sd">        suborbital_radar : str</span>
<span class="sd">            Name of the suborbital radar (abbreviated).</span>
<span class="sd">        input_radar_format : str</span>
<span class="sd">            Format of the input radar data (e.g. cloudnet).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># make sure that geometry is valid</span>
        <span class="k">if</span> <span class="n">geometry</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Geometry </span><span class="si">{</span><span class="n">geometry</span><span class="si">}</span><span class="s2"> not implemented. Choose from &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># check if site is in list of implemented sites</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">geometry</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Site </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> not implemented. Choose from &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">geometry</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># check if config file is provided and exists</span>
        <span class="k">if</span> <span class="n">config_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No configuration file provided&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;ORBITAL_RADAR_CONFIG_PATH&quot;</span><span class="p">],</span> <span class="n">config_file</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Configuration file </span><span class="si">{</span><span class="n">config_file</span><span class="si">}</span><span class="s2"> not found&quot;</span>
            <span class="p">)</span>

        <span class="c1"># set class attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">=</span> <span class="n">geometry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suborbital_radar</span> <span class="o">=</span> <span class="n">suborbital_radar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_radar_format</span> <span class="o">=</span> <span class="n">input_radar_format</span>

        <span class="c1"># attributes that will be derived</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_sea_level</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># read configuration file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">read_config</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>

        <span class="c1"># check if output path exists</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;paths&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;output&quot;</span><span class="p">]</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Output path </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;output&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> does not exist&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">path_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;paths&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;output&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;suborbital_radar&quot;</span><span class="p">][</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">suborbital_radar</span>
        <span class="p">][</span><span class="s2">&quot;frequency&quot;</span><span class="p">]</span>

        <span class="c1"># preparation of input radar data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;prepare&quot;</span><span class="p">][</span><span class="s2">&quot;general&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;prepare&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">])</span>

        <span class="c1"># overview of simulation settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">summary</span>

        <span class="c1"># initialize simulator class with spaceborne radar settings</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">sat_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;spaceborne_radar&quot;</span><span class="p">][</span><span class="s2">&quot;sat_name&quot;</span><span class="p">],</span>
            <span class="n">file_earthcare</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;spaceborne_radar&quot;</span><span class="p">][</span><span class="s2">&quot;file_earthcare&quot;</span><span class="p">],</span>
            <span class="n">nyquist_from_prf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;spaceborne_radar&quot;</span><span class="p">][</span><span class="s2">&quot;nyquist_from_prf&quot;</span><span class="p">],</span>
            <span class="n">ms_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;spaceborne_radar&quot;</span><span class="p">][</span><span class="s2">&quot;ms_threshold&quot;</span><span class="p">],</span>
            <span class="n">ms_threshold_integral</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;spaceborne_radar&quot;</span><span class="p">][</span>
                <span class="s2">&quot;ms_threshold_integral&quot;</span>
            <span class="p">],</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;spaceborne_radar&quot;</span><span class="p">][</span><span class="s2">&quot;radar_specs&quot;</span><span class="p">],</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prints short summary of simulator settings.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Site: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Directory paths:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;radar&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;paths&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;output&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">==</span> <span class="s2">&quot;groundbased&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Groundbased data is prepared with:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean wind: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">[</span><span class="s1">&#39;mean_wind&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> m/s&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">==</span> <span class="s2">&quot;airborne&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Airborne data is prepared with:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Mean flight velocity: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">[</span><span class="s1">&#39;mean_flight_velocity&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> m/s&quot;</span>
            <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Height min: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">[</span><span class="s1">&#39;height_min&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> m&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Height max: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">[</span><span class="s1">&#39;height_max&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> m&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Height res: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">[</span><span class="s1">&#39;height_res&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> m&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Suborbital.prepare_dates"><a class="viewcode-back" href="../../api/suborbital.html#orbital_radar.suborbital.Suborbital.prepare_dates">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">prepare_dates</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a date array from start to end date.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        start_date : np.datetime64</span>
<span class="sd">            Start date.</span>
<span class="sd">        end_date : np.datetime64</span>
<span class="sd">            End date.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dates: pd.DatetimeIndex</span>
<span class="sd">            Date range from start to end date.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># check if start date is before end date</span>
        <span class="k">if</span> <span class="n">start_date</span> <span class="o">&gt;</span> <span class="n">end_date</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Start date must be before end date&quot;</span><span class="p">)</span>

        <span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dates</span></div>

<div class="viewcode-block" id="Suborbital.convert_frequency"><a class="viewcode-back" href="../../api/suborbital.html#orbital_radar.suborbital.Suborbital.convert_frequency">[docs]</a>    <span class="k">def</span> <span class="nf">convert_frequency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert frequency from 35 to 94 GHz.</span>

<span class="sd">        The conversion is based on Kollias et al. (2019)</span>
<span class="sd">        (doi: https://doi.org/10.5194/amt-12-4949-2019)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ds : xarray.Dataset</span>
<span class="sd">            Data with &quot;ze&quot; variable in mm6/mm3. Ze was measured at 35 GHz.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ds : xarray.Dataset</span>
<span class="sd">            Data with converted &quot;ze&quot; variable. Ze is now transformed to 94 GHz.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># keep only reflectivities below 30 dBZ</span>
        <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;ze&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;ze&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;ze&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">db2li</span><span class="p">(</span><span class="mi">30</span><span class="p">))</span>

        <span class="n">a</span> <span class="o">=</span> <span class="o">-</span><span class="mf">16.8251</span>
        <span class="n">b</span> <span class="o">=</span> <span class="mf">8.4923</span>
        <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;ze&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">db2li</span><span class="p">(</span>
            <span class="n">li2db</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;ze&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">10</span><span class="o">**</span><span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="n">li2db</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;ze&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">100</span><span class="p">)</span> <span class="o">**</span> <span class="n">b</span>
        <span class="p">)</span>

        <span class="c1"># set negative ze to zero</span>
        <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;ze&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;ze&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;ze&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ds</span></div>

<div class="viewcode-block" id="Suborbital.correct_dielectric_constant"><a class="viewcode-back" href="../../api/suborbital.html#orbital_radar.suborbital.Suborbital.correct_dielectric_constant">[docs]</a>    <span class="k">def</span> <span class="nf">correct_dielectric_constant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply correction for dielectric constant assumed in Ze calculation</span>
<span class="sd">        of suborbital radar to match the dielectric constant of the</span>
<span class="sd">        spaceborne radar.</span>

<span class="sd">        Correction equation with :math:`K_g` and :math:`K_s` as dielectric</span>
<span class="sd">        constants of the suborbital and spaceborne radar, respectively:</span>

<span class="sd">        .. math::</span>
<span class="sd">           Z_e = 10 \log_{10} \left( \frac{K_s}{K_g} \right) + Z_e</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ds : xarray.Dataset</span>
<span class="sd">            Data with &quot;ze&quot; variable.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">correction</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;spaceborne_radar&quot;</span><span class="p">][</span><span class="s2">&quot;k2&quot;</span><span class="p">]</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;suborbital_radar&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">suborbital_radar</span><span class="p">][</span><span class="s2">&quot;k2&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;ze&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">db2li</span><span class="p">(</span><span class="n">li2db</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;ze&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">correction</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">ds</span></div>

<div class="viewcode-block" id="Suborbital.add_vmze_attrs"><a class="viewcode-back" href="../../api/suborbital.html#orbital_radar.suborbital.Suborbital.add_vmze_attrs">[docs]</a>    <span class="k">def</span> <span class="nf">add_vmze_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds attributes to Doppler velocity and radar reflectivity variables.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ds : xarray.Dataset</span>
<span class="sd">            Data with &quot;ze&quot; and &quot;vm&quot; variables.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ds : xarray.Dataset</span>
<span class="sd">            Data with added attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;ze&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">units</span><span class="o">=</span><span class="s2">&quot;mm6 m-3&quot;</span><span class="p">,</span>
            <span class="n">standard_name</span><span class="o">=</span><span class="s2">&quot;radar_reflectivity&quot;</span><span class="p">,</span>
            <span class="n">long_name</span><span class="o">=</span><span class="s2">&quot;Radar reflectivity&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Radar reflectivity&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;vm&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">units</span><span class="o">=</span><span class="s2">&quot;m s-1&quot;</span><span class="p">,</span>
            <span class="n">standard_name</span><span class="o">=</span><span class="s2">&quot;Doppler_velocity&quot;</span><span class="p">,</span>
            <span class="n">long_name</span><span class="o">=</span><span class="s2">&quot;Doppler velocity&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Doppler velocity&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">ds</span></div>

<div class="viewcode-block" id="Suborbital.check_is_sea_level"><a class="viewcode-back" href="../../api/suborbital.html#orbital_radar.suborbital.Suborbital.check_is_sea_level">[docs]</a>    <span class="k">def</span> <span class="nf">check_is_sea_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if input radar range/height grid is defined with respect to</span>
<span class="sd">        ground level or sea level. The input to the simulator should be wrt.</span>
<span class="sd">        sea level.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ds : xr.Dataset</span>
<span class="sd">            Input radar data</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;height&quot;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_sea_level</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_sea_level</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Suborbital.range_to_height"><a class="viewcode-back" href="../../api/suborbital.html#orbital_radar.suborbital.Suborbital.range_to_height">[docs]</a>    <span class="k">def</span> <span class="nf">range_to_height</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert range coordinate to height coordinate by adding the station</span>
<span class="sd">        height above mean sea level to the range coordinate.</span>

<span class="sd">        The altitude is pre-defined for each station in the configuration file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ds : xarray.Dataset</span>
<span class="sd">            Data with &quot;range&quot; coordinate.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;range&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">ds</span><span class="o">.</span><span class="n">alt</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

        <span class="c1"># swap range with height</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">swap_dims</span><span class="p">({</span><span class="s2">&quot;range&quot;</span><span class="p">:</span> <span class="s2">&quot;height&quot;</span><span class="p">})</span>

        <span class="c1"># drop range coordinate</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ds</span></div>

<div class="viewcode-block" id="Suborbital.create_along_track"><a class="viewcode-back" href="../../api/suborbital.html#orbital_radar.suborbital.Suborbital.create_along_track">[docs]</a>    <span class="k">def</span> <span class="nf">create_along_track</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates along-track coordinates from time coordinates.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ds : xarray.Dataset</span>
<span class="sd">            Data with &quot;time&quot; and &quot;height&quot; coordinates.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ds : xarray.Dataset</span>
<span class="sd">            Data with &quot;along_track&quot; coordinate.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">==</span> <span class="s2">&quot;groundbased&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using mean wind for along-track coordinates&quot;</span><span class="p">)</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">[</span><span class="s2">&quot;mean_wind&quot;</span><span class="p">]</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">==</span> <span class="s2">&quot;airborne&quot;</span> <span class="ow">and</span> <span class="s2">&quot;ac_speed&quot;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">ds</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using flight velocity for along-track coordinates&quot;</span><span class="p">)</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">ac_speed</span><span class="o">.</span><span class="n">values</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">==</span> <span class="s2">&quot;airborne&quot;</span> <span class="ow">and</span> <span class="s2">&quot;ac_speed&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">ds</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using mean flight velocity for along-track coordinates&quot;</span><span class="p">)</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">[</span><span class="s2">&quot;mean_flight_velocity&quot;</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Geometry </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="si">}</span><span class="s2"> not implemented. Choose from &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># calculate the along-track distance</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">)</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># start is dt=0</span>
        <span class="n">arr_along_track</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">v</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span>

        <span class="n">da_along_track</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
            <span class="n">arr_along_track</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="p">[</span><span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;along_track&quot;</span>
        <span class="p">)</span>
        <span class="n">da_along_track</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">standard_name</span><span class="o">=</span><span class="s2">&quot;along_track_distance&quot;</span><span class="p">,</span>
            <span class="n">long_name</span><span class="o">=</span><span class="s2">&quot;Along track distance&quot;</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=</span><span class="s2">&quot;m&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Distance along track of the suborbital radar&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># swap from time to along track</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">along_track</span><span class="o">=</span><span class="n">da_along_track</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">swap_dims</span><span class="p">({</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="s2">&quot;along_track&quot;</span><span class="p">})</span>

        <span class="c1"># add time as variable</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">ds</span></div>

<div class="viewcode-block" id="Suborbital.create_regular_height"><a class="viewcode-back" href="../../api/suborbital.html#orbital_radar.suborbital.Suborbital.create_regular_height">[docs]</a>    <span class="k">def</span> <span class="nf">create_regular_height</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates regular height coordinate for suborbital radar.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.DataArray</span>
<span class="sd">            Regular height coordinate for suborbital radar.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">height_regular</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">[</span><span class="s2">&quot;height_min&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">[</span><span class="s2">&quot;height_max&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">[</span><span class="s2">&quot;height_res&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="n">da_height_regular</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
            <span class="n">height_regular</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="p">[</span><span class="n">height_regular</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">da_height_regular</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">units</span><span class="o">=</span><span class="s2">&quot;m&quot;</span><span class="p">,</span>
            <span class="n">standard_name</span><span class="o">=</span><span class="s2">&quot;height&quot;</span><span class="p">,</span>
            <span class="n">long_name</span><span class="o">=</span><span class="s2">&quot;Height of radar bin above sea level&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Height of radar bin above sea level&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">da_height_regular</span></div>

<div class="viewcode-block" id="Suborbital.create_regular_along_track"><a class="viewcode-back" href="../../api/suborbital.html#orbital_radar.suborbital.Suborbital.create_regular_along_track">[docs]</a>    <span class="k">def</span> <span class="nf">create_regular_along_track</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates regular along-track coordinate for suborbital radar.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ds : xarray.Dataset</span>
<span class="sd">            Data with &quot;along_track&quot; coordinate.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.DataArray</span>
<span class="sd">            Regular along-track coordinate for suborbital radar.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">along_track_res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
            <span class="n">ds</span><span class="o">.</span><span class="n">along_track</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="s2">&quot;along_track&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">along_track_max</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">along_track</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

        <span class="n">along_track_regular</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="n">along_track_max</span><span class="p">,</span>
            <span class="n">along_track_res</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">da_along_track_regular</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
            <span class="n">along_track_regular</span><span class="p">,</span>
            <span class="n">dims</span><span class="o">=</span><span class="s2">&quot;along_track&quot;</span><span class="p">,</span>
            <span class="n">coords</span><span class="o">=</span><span class="p">[</span><span class="n">along_track_regular</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">da_along_track_regular</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">along_track</span><span class="o">.</span><span class="n">attrs</span>

        <span class="k">return</span> <span class="n">da_along_track_regular</span></div>

<div class="viewcode-block" id="Suborbital.interpolate_to_regular_grid"><a class="viewcode-back" href="../../api/suborbital.html#orbital_radar.suborbital.Suborbital.interpolate_to_regular_grid">[docs]</a>    <span class="k">def</span> <span class="nf">interpolate_to_regular_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Interpolates radar data to regular grid in along-track and height.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ds : xarray.Dataset</span>
<span class="sd">            Data with &quot;time&quot; and &quot;height&quot; coordinates.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ds : xarray.Dataset</span>
<span class="sd">            Data with interpolated &quot;along_track&quot; and &quot;height&quot; coordinates.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">da_height_regular</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_regular_height</span><span class="p">()</span>
        <span class="n">da_along_track_regular</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_regular_along_track</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">ds</span><span class="p">)</span>

        <span class="c1"># interpolation along-track and height</span>
        <span class="c1"># workaround for time: convert to seconds since start, then</span>
        <span class="c1"># interpolate, then convert back to datetime</span>
        <span class="n">da_time</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
            <span class="n">along_track</span><span class="o">=</span><span class="n">da_along_track_regular</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="n">da_height_regular</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># get nearest time for each regular along track grid point</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="s2">&quot;along_track&quot;</span><span class="p">),</span>
            <span class="n">da_time</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">along_track</span><span class="o">=</span><span class="n">ds</span><span class="o">.</span><span class="n">along_track</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># add attributes</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_vmze_attrs</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ds</span></div>

<div class="viewcode-block" id="Suborbital.add_ground_echo"><a class="viewcode-back" href="../../api/suborbital.html#orbital_radar.suborbital.Suborbital.add_ground_echo">[docs]</a>    <span class="k">def</span> <span class="nf">add_ground_echo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates artificial ground echo inside ground-based radar range</span>
<span class="sd">        grid. The values are chosen such that the final ground echo after</span>
<span class="sd">        the along-range convolution is equal to the ground echo of the</span>
<span class="sd">        satellite. The pulse length used here is not the same as the pulse</span>
<span class="sd">        length of the satellite.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ds : xarray.Dataset</span>
<span class="sd">            Data with &quot;ze&quot; and &quot;vm&quot; variables.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ds : xarray.Dataset</span>
<span class="sd">            Data with added ground echo.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">height</span><span class="p">)))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span>
            <span class="s2">&quot;Height grid is not equidistant. &quot;</span>
            <span class="s2">&quot;Range weighting function cannot be calculated.&quot;</span>
        <span class="p">)</span>

        <span class="c1"># grid with size of two pulse lengths centered around zero</span>
        <span class="n">height_bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
            <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">[</span><span class="s2">&quot;ground_echo_pulse_length&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">[</span><span class="s2">&quot;ground_echo_pulse_length&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">[</span><span class="s2">&quot;height_res&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">[</span><span class="s2">&quot;height_res&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># calculate range weighting function</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">RadarBeam</span><span class="o">.</span><span class="n">normalized_range_weighting_function_default</span><span class="p">(</span>
            <span class="n">pulse_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">[</span><span class="s2">&quot;ground_echo_pulse_length&quot;</span><span class="p">],</span>
            <span class="n">range_bins</span><span class="o">=</span><span class="n">height_bins</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">ground_echo</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">*</span> <span class="n">db2li</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">[</span><span class="s2">&quot;ground_echo_ze_max&quot;</span><span class="p">])</span>

        <span class="c1"># add ground echo to dataset shifted by one height bin to have maximum</span>
        <span class="c1"># below zero</span>
        <span class="c1"># get closest height bin to ground</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="n">ds</span><span class="o">.</span><span class="n">alt</span><span class="o">.</span><span class="n">item</span><span class="p">()))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">height</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

        <span class="c1"># insert half of the calculated ground echo and shift maximum below the</span>
        <span class="c1"># surface</span>
        <span class="n">ground_echo</span> <span class="o">=</span> <span class="n">ground_echo</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ground_echo</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="p">:]</span>
        <span class="n">height_bins</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">base</span>
            <span class="o">+</span> <span class="n">height_bins</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">height_bins</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="p">:]</span>
            <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">[</span><span class="s2">&quot;height_res&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># add ground echo to dataset (first fill nan values with zero in this</span>
        <span class="c1"># height interval)</span>
        <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;ze&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[{</span><span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">height_bins</span><span class="p">}]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;ze&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[{</span><span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">height_bins</span><span class="p">}]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;ze&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[{</span><span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">height_bins</span><span class="p">}]</span> <span class="o">+=</span> <span class="n">ground_echo</span>

        <span class="k">return</span> <span class="n">ds</span></div>

<div class="viewcode-block" id="Suborbital.add_groundbased_variables"><a class="viewcode-back" href="../../api/suborbital.html#orbital_radar.suborbital.Suborbital.add_groundbased_variables">[docs]</a>    <span class="k">def</span> <span class="nf">add_groundbased_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add variables specific to groundbased simulator to the dataset, i.e.,</span>
<span class="sd">        the mean horizontal wind.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;mean_wind&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">[</span><span class="s2">&quot;mean_wind&quot;</span><span class="p">],</span>
            <span class="n">attrs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">standard_name</span><span class="o">=</span><span class="s2">&quot;v_hor&quot;</span><span class="p">,</span>
                <span class="n">long_name</span><span class="o">=</span><span class="s2">&quot;Mean horizontal wind&quot;</span><span class="p">,</span>
                <span class="n">units</span><span class="o">=</span><span class="s2">&quot;m s-1&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Mean horizontal wind&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Suborbital.add_airborne_variables"><a class="viewcode-back" href="../../api/suborbital.html#orbital_radar.suborbital.Suborbital.add_airborne_variables">[docs]</a>    <span class="k">def</span> <span class="nf">add_airborne_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add variables specific to airborne simulator to the dataset, i.e.,</span>
<span class="sd">        the mean flight velocity.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;mean_flight_velocity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">[</span><span class="s2">&quot;mean_flight_velocity&quot;</span><span class="p">],</span>
            <span class="n">attrs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">standard_name</span><span class="o">=</span><span class="s2">&quot;v_hor&quot;</span><span class="p">,</span>
                <span class="n">long_name</span><span class="o">=</span><span class="s2">&quot;Mean flight velocity&quot;</span><span class="p">,</span>
                <span class="n">units</span><span class="o">=</span><span class="s2">&quot;m s-1&quot;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Mean flight velocity&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Suborbital.to_netcdf"><a class="viewcode-back" href="../../api/suborbital.html#orbital_radar.suborbital.Suborbital.to_netcdf">[docs]</a>    <span class="k">def</span> <span class="nf">to_netcdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes dataset to netcdf file. Note that not all variables are stored.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        date : np.datetime64</span>
<span class="sd">            Date of the simulation. Used to create the filename.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">output_variables</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;sat_ifov&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sat_range_resolution&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sat_along_track_resolution&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ze&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vm&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ze_sat&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vm_sat&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vm_sat_vel&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ze_sat_noise&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vm_sat_noise&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vm_sat_folded&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nubf_flag&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ms_flag&quot;</span><span class="p">,</span>
            <span class="s2">&quot;folding_flag&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">==</span> <span class="s2">&quot;groundbased&quot;</span><span class="p">:</span>
            <span class="n">output_variables</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;mean_wind&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">==</span> <span class="s2">&quot;airborne&quot;</span><span class="p">:</span>
            <span class="n">output_variables</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;mean_flight_velocity&quot;</span><span class="p">]</span>

        <span class="c1"># name of output nc file</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s2">&quot;ora&quot;</span><span class="p">,</span>
                    <span class="n">__version__</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;spaceborne_radar&quot;</span><span class="p">][</span><span class="s2">&quot;sat_name&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;l1&quot;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">suborbital_radar</span><span class="p">,</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">date</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;T000000&quot;</span><span class="p">,</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">date</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;T235959&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;.nc&quot;</span>
        <span class="p">)</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path_out</span><span class="p">,</span>
            <span class="n">filename</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">write_spaceview</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">output_variables</span><span class="p">],</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span></div>

<div class="viewcode-block" id="Suborbital.add_attenuation"><a class="viewcode-back" href="../../api/suborbital.html#orbital_radar.suborbital.Suborbital.add_attenuation">[docs]</a>    <span class="k">def</span> <span class="nf">add_attenuation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">da_gas_atten</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add attenuation to dataset.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ds : xarray.Dataset</span>
<span class="sd">            Data with &quot;ze&quot; variable. Unit: mm6 m-3</span>
<span class="sd">        da_gas_atten : xarray.DataArray</span>
<span class="sd">            Interpolated gas attenuation data on the same grid as ds.</span>
<span class="sd">            Unit: dBZ.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ds : xarray.Dataset</span>
<span class="sd">            Data with added attenuation.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># add attenuation in dB and convert back to</span>
        <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;ze&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">db2li</span><span class="p">(</span><span class="n">li2db</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;ze&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="n">da_gas_atten</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ds</span></div>

<div class="viewcode-block" id="Suborbital.attenuation_correction"><a class="viewcode-back" href="../../api/suborbital.html#orbital_radar.suborbital.Suborbital.attenuation_correction">[docs]</a>    <span class="k">def</span> <span class="nf">attenuation_correction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">ds_cloudnet</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gas attenuation correction based on Cloudnet.</span>

<span class="sd">        Cloudnet contains gas attenuation (gas_atten) as a function of 137</span>
<span class="sd">        ERA5 levels. The height of each level varies with time. Therefore,</span>
<span class="sd">        the height is first interpolated onto the height grid of the radar</span>
<span class="sd">        data. Then, the gas attenuation is interpolated onto the time and</span>
<span class="sd">        height grid of the radar data. Finally, the gas attenuation is added</span>
<span class="sd">        to the radar reflectivity.</span>

<span class="sd">        There are major differences between the cloudnet_ecmwf and</span>
<span class="sd">        cloudnet_categorize attenuation products:</span>
<span class="sd">        - ecmwf height is time-dependent, categorize height is not</span>
<span class="sd">        - ecmwf height is wrt ground, categorize height is wrt mean sea level</span>
<span class="sd">        - ecmwf variable is named &quot;radar_gas_atten&quot;, categorize variable is</span>
<span class="sd">        named &quot;gas_atten&quot;</span>
<span class="sd">        - ecmwf is calculated for both frequencies, categorize only for 94 GHz</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ds : xarray.Dataset</span>
<span class="sd">            Data with &quot;ze&quot; variable. Unit: mm6 m-3</span>
<span class="sd">        ds_cloudnet : xarray.Dataset</span>
<span class="sd">            Cloudnet data with &quot;gas_atten&quot; variable. Unit: dBZ</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ds : xarray.Dataset</span>
<span class="sd">            Data with added attenuation.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># select 94 GHz frequency</span>
        <span class="k">if</span> <span class="s2">&quot;frequency&quot;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">ds_cloudnet</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span>
            <span class="n">ds_cloudnet</span> <span class="o">=</span> <span class="n">ds_cloudnet</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">frequency</span><span class="o">=</span><span class="mi">94</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">[</span><span class="s2">&quot;attenuation_correction_input&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;cloudnet_ecmwf&quot;</span><span class="p">:</span>
            <span class="n">lst_da_gas_atten</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="n">ds_cloudnet</span><span class="o">.</span><span class="n">time</span><span class="p">:</span>

                <span class="c1"># interpolate gas attenuation to radar height grid</span>
                <span class="n">ds_cloudnet_t</span> <span class="o">=</span> <span class="n">ds_cloudnet</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">)</span><span class="o">.</span><span class="n">swap_dims</span><span class="p">(</span>
                    <span class="p">{</span><span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="s2">&quot;height&quot;</span><span class="p">}</span>
                <span class="p">)</span>

                <span class="n">da_cloudnet_gas_atten_t</span> <span class="o">=</span> <span class="n">ds_cloudnet_t</span><span class="o">.</span><span class="n">gas_atten</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                    <span class="n">height</span><span class="o">=</span><span class="n">ds</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span>
                <span class="p">)</span>

                <span class="n">lst_da_gas_atten</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">da_cloudnet_gas_atten_t</span><span class="p">)</span>

            <span class="c1"># merge all time steps</span>
            <span class="n">da_gas_atten</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">lst_da_gas_atten</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>

            <span class="c1"># drop levels</span>
            <span class="n">da_gas_atten</span> <span class="o">=</span> <span class="n">da_gas_atten</span><span class="o">.</span><span class="n">reset_coords</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">elif</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">[</span><span class="s2">&quot;attenuation_correction_input&quot;</span><span class="p">]</span>
            <span class="o">==</span> <span class="s2">&quot;cloudnet_categorize&quot;</span>
        <span class="p">):</span>
            <span class="c1"># rename to match ecmwf variable</span>
            <span class="n">ds_cloudnet</span> <span class="o">=</span> <span class="n">ds_cloudnet</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;radar_gas_atten&quot;</span><span class="p">:</span> <span class="s2">&quot;gas_atten&quot;</span><span class="p">})</span>

            <span class="c1"># interpolate to radar height grid</span>
            <span class="n">da_gas_atten</span> <span class="o">=</span> <span class="n">ds_cloudnet</span><span class="o">.</span><span class="n">gas_atten</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                <span class="n">height</span><span class="o">=</span><span class="n">ds</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Attenuation correction input &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">[</span><span class="s1">&#39;attenuation_correction_input&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> not &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;implemented&quot;</span>
            <span class="p">)</span>

        <span class="c1"># interpolate to radar time grid and extrapolate if needed</span>
        <span class="n">da_gas_atten</span> <span class="o">=</span> <span class="n">da_gas_atten</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
            <span class="n">time</span><span class="o">=</span><span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fill_value&quot;</span><span class="p">:</span> <span class="s2">&quot;extrapolate&quot;</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># ensures every time step contains attenuation in range column</span>
        <span class="n">has_atten</span> <span class="o">=</span> <span class="o">~</span><span class="n">da_gas_atten</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">has_atten</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Attenuation missing for times: </span><span class="si">{</span><span class="n">da_gas_atten</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="o">~</span><span class="n">has_atten</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># fill nan values with zero</span>
        <span class="n">da_gas_atten</span> <span class="o">=</span> <span class="n">da_gas_atten</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># apply attenuation correction</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_attenuation</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">ds</span><span class="p">,</span> <span class="n">da_gas_atten</span><span class="o">=</span><span class="n">da_gas_atten</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ds</span></div>

<div class="viewcode-block" id="Suborbital.run_date"><a class="viewcode-back" href="../../api/suborbital.html#orbital_radar.suborbital.Suborbital.run_date">[docs]</a>    <span class="k">def</span> <span class="nf">run_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">write_output</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs simulation for a single day.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        date : np.datetime64</span>
<span class="sd">            Date to simulate.</span>
<span class="sd">        write_output : bool</span>
<span class="sd">            If True, write output to netcdf file.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># read radar data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_radar_format</span> <span class="o">==</span> <span class="s2">&quot;cloudnet&quot;</span><span class="p">:</span>
            <span class="n">radar_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;paths&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;cloudnet&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">radar_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;paths&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;radar&quot;</span><span class="p">]</span>

        <span class="n">rad</span> <span class="o">=</span> <span class="n">Radar</span><span class="p">(</span>
            <span class="n">date</span><span class="o">=</span><span class="n">date</span><span class="p">,</span>
            <span class="n">site_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">path</span><span class="o">=</span><span class="n">radar_path</span><span class="p">,</span>
            <span class="n">input_radar_format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">input_radar_format</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># skip if radar data does not exist</span>
        <span class="k">if</span> <span class="n">rad</span><span class="o">.</span><span class="n">ds_rad</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">date</span><span class="si">}</span><span class="s2">: No radar data found&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># read cloudnet data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">==</span> <span class="s2">&quot;groundbased&quot;</span><span class="p">:</span>
            <span class="n">ds_cloudnet</span> <span class="o">=</span> <span class="n">read_cloudnet</span><span class="p">(</span>
                <span class="n">attenuation_correction_input</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">[</span>
                    <span class="s2">&quot;attenuation_correction_input&quot;</span>
                <span class="p">],</span>
                <span class="n">date</span><span class="o">=</span><span class="n">date</span><span class="p">,</span>
                <span class="n">site_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;paths&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;cloudnet&quot;</span><span class="p">],</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">ds_cloudnet</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">[</span><span class="s2">&quot;attenuation_correction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># frequency conversion</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span> <span class="o">==</span> <span class="mi">35</span><span class="p">:</span>
            <span class="n">rad</span><span class="o">.</span><span class="n">ds_rad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_frequency</span><span class="p">(</span><span class="n">rad</span><span class="o">.</span><span class="n">ds_rad</span><span class="p">)</span>

        <span class="c1"># correct dielectric constant</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span> <span class="o">==</span> <span class="mi">94</span><span class="p">:</span>
            <span class="n">rad</span><span class="o">.</span><span class="n">ds_rad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">correct_dielectric_constant</span><span class="p">(</span><span class="n">rad</span><span class="o">.</span><span class="n">ds_rad</span><span class="p">)</span>

        <span class="c1"># range to height</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_is_sea_level</span><span class="p">(</span><span class="n">rad</span><span class="o">.</span><span class="n">ds_rad</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">==</span> <span class="s2">&quot;groundbased&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_sea_level</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Converting radar range grid to height above mean sea level&quot;</span><span class="p">)</span>
            <span class="n">rad</span><span class="o">.</span><span class="n">ds_rad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">range_to_height</span><span class="p">(</span><span class="n">rad</span><span class="o">.</span><span class="n">ds_rad</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Assume that input radar grid is defined as height above mean &quot;</span>
                <span class="s2">&quot;sea level&quot;</span>
            <span class="p">)</span>

        <span class="c1"># create along track dimension</span>
        <span class="n">rad</span><span class="o">.</span><span class="n">ds_rad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_along_track</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="n">rad</span><span class="o">.</span><span class="n">ds_rad</span><span class="p">)</span>

        <span class="c1"># interpolate to regular grid</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate_to_regular_grid</span><span class="p">(</span><span class="n">rad</span><span class="o">.</span><span class="n">ds_rad</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">==</span> <span class="s2">&quot;groundbased&quot;</span><span class="p">:</span>
            <span class="c1"># attenuation correction</span>
            <span class="c1"># no attenuation correction with 35 GHz radar reflectivity</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span> <span class="o">==</span> <span class="mi">35</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">[</span><span class="s2">&quot;attenuation_correction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">[</span><span class="s2">&quot;attenuation_correction&quot;</span><span class="p">]:</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attenuation_correction</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">ds_cloudnet</span><span class="p">)</span>

            <span class="c1"># add ground echo</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_ground_echo</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>

        <span class="c1"># run simulator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>

        <span class="c1"># add horizontal wind variable</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">==</span> <span class="s2">&quot;groundbased&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_groundbased_variables</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">==</span> <span class="s2">&quot;airborne&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_airborne_variables</span><span class="p">()</span>

        <span class="c1"># write output to file</span>
        <span class="k">if</span> <span class="n">write_output</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="n">date</span><span class="p">)</span></div>

<div class="viewcode-block" id="Suborbital.run"><a class="viewcode-back" href="../../api/suborbital.html#orbital_radar.suborbital.Suborbital.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">write_output</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs simulation for all days in the time frame.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        start_date : np.datetime64</span>
<span class="sd">            Start date.</span>
<span class="sd">        end_date : np.datetime64</span>
<span class="sd">            End date (inclusive).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">dates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_dates</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">date</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dates</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">date</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">run_date</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">write_output</span><span class="o">=</span><span class="n">write_output</span><span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Nils Risse, Lukas Pfitzenmaier, Pavlos Kollias, Bernat Puigdomenech.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>